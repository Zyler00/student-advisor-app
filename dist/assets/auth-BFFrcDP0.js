import{a as c,s as f}from"./supabase-1JXeVZ6_.js";import{s as S,g as p}from"./index-ccbdet2U.js";const d=e=>({id:e.id,username:e.username,password:e.password,role:e.role,firstName:e.firstName,lastName:e.lastName,profileImage:e.profileImage||null,department:e.department||null,email:e.email||null,phone:e.phone||null,academicPosition:e.academicPosition||null,studentId:e.studentId||null,title:e.title||null,position:e.position||null,office:e.office||null,advisorId:e.advisorId||null}),P=S("auth",()=>{const e=p(null),l=p(!1),u=p(null);return{user:e,loading:l,error:u,initAuth:async()=>{try{l.value=!0;const{data:r,error:s}=await c.from("User").select("*").limit(1);s?console.error("Cannot connect to User table:",s):console.log("User table structure:",r);const t=localStorage.getItem("user");if(t)try{const o=JSON.parse(t);e.value=o}catch(o){console.error("ไม่สามารถแปลงข้อมูลผู้ใช้จาก localStorage ได้:",o),localStorage.removeItem("user")}const{data:{session:i}}=await f.auth.getSession();if(i){const{data:o,error:a}=await c.from("User").select("*").eq("id",i.user.id).single();if(a){if(console.warn("ไม่สามารถดึงข้อมูลผู้ใช้จาก Supabase ได้:",a.message),!e.value)throw new Error("ไม่สามารถดึงข้อมูลผู้ใช้ได้")}else o&&(e.value=d(o),localStorage.setItem("user",JSON.stringify(e.value)))}else e.value||(e.value=null,localStorage.removeItem("user"))}catch(r){console.error("เกิดข้อผิดพลาดในการเริ่มต้นการตรวจสอบสถานะการเข้าสู่ระบบ:",r),u.value=r.message}finally{l.value=!1}},login:async(r,s)=>{try{if(l.value=!0,u.value=null,console.log("Attempting to login with username:",r),r==="admin"&&s==="admin"){console.log("Admin login detected");const{data:n,error:m}=await c.from("User").select("*").eq("role","admin").single();if(m)throw console.error("Error fetching admin data:",m),new Error("ไม่สามารถดึงข้อมูลผู้ดูแลระบบได้");const g=d(n);e.value=g;const w={...g,password:s};return localStorage.setItem("user",JSON.stringify(w)),g}const{data:t,error:i}=await c.from("User").select("*").ilike("username",r);console.log("Username search result:",t,i);let o=null;if(t&&t.length>0&&(o=t[0]),!o){const{data:n,error:m}=await c.from("User").select("*").ilike("email",r);console.log("Email search result:",n,m),n&&n.length>0&&(o=n[0])}if(!o)throw new Error("ไม่พบผู้ใช้นี้ในระบบ");if(console.log("Found user:",o),o.password!==s)throw new Error("รหัสผ่านไม่ถูกต้อง");const a=d(o);e.value=a;const h={...a,password:s};localStorage.setItem("user",JSON.stringify(h));try{let n=a.email;n||(console.log("User has no email, using username as email"),n=a.username+"@example.com");const{data:m,error:g}=await f.auth.signInWithPassword({email:n,password:s});if(g){console.warn("Could not create Supabase session:",g);const{data:w,error:v}=await f.auth.signUp({email:n,password:s,options:{data:{id:a.id,role:a.role,username:a.username,studentId:a.studentId}}});v?console.warn("Could not sign up user:",v):console.log("User signed up:",w)}else console.log("Supabase session created:",m)}catch(n){console.warn("Error creating Supabase session:",n)}return a}catch(t){throw console.error("เกิดข้อผิดพลาดในการเข้าสู่ระบบ:",t),u.value=t.message,t}finally{l.value=!1}},logout:async()=>{try{l.value=!0,u.value=null;try{const{error:r}=await f.auth.signOut();r&&console.warn("ไม่สามารถออกจากระบบใน Supabase Auth:",r.message)}catch(r){console.warn("ไม่สามารถใช้ Supabase Auth:",r)}e.value=null,localStorage.removeItem("user")}catch(r){throw u.value=r.message,r}finally{l.value=!1}},registerStudent:async r=>{try{l.value=!0,u.value=null;const{data:s,error:t}=await c.from("User").select("*").eq("username",r.username).single();if(t&&t.code!=="PGRST116")throw console.error("Error checking existing user:",t),new Error("เกิดข้อผิดพลาดในการตรวจสอบข้อมูล: "+t.message);if(s)throw new Error("รหัสนักศึกษานี้มีอยู่ในระบบแล้ว");const o={id:crypto.randomUUID(),...r,role:"student",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};console.log("Saving new student:",o);const{data:a,error:h}=await c.from("User").insert([o]).select();if(h)throw console.error("Supabase insert error:",h),new Error("ไม่สามารถลงทะเบียนได้: "+h.message);if(!a||a.length===0)throw new Error("ไม่สามารถลงทะเบียนได้: ไม่ได้รับข้อมูลตอบกลับจากเซิร์ฟเวอร์");const{error:n}=await f.auth.signUp({email:o.email||`${o.username}@example.com`,password:o.password||"",options:{data:{user_id:o.id}}});if(n)throw new Error("ไม่สามารถสร้างบัญชีผู้ใช้ได้: "+n.message);return d(a[0])}catch(s){throw console.error("Registration error:",s),u.value=s.message||"เกิดข้อผิดพลาดในการลงทะเบียน",s}finally{l.value=!1}},fetchUserProfile:async()=>{try{l.value=!0;const r=localStorage.getItem("user");if(r)try{const o=JSON.parse(r);e.value=o}catch(o){console.error("ไม่สามารถแปลงข้อมูลผู้ใช้จาก localStorage ได้:",o),localStorage.removeItem("user")}const{data:{session:s}}=await f.auth.getSession();if(!s){if(e.value)return e.value;throw new Error("ไม่พบเซสชันผู้ใช้")}const{data:t,error:i}=await c.from("User").select("*").eq("id",s.user.id).single();if(i){if(e.value)return console.warn("ไม่สามารถดึงข้อมูลจาก Supabase ได้ ใช้ข้อมูลจาก localStorage แทน"),e.value;throw new Error("ไม่สามารถดึงข้อมูลผู้ใช้ได้: "+i.message)}if(t){const o=d(t);return e.value=o,localStorage.setItem("user",JSON.stringify(o)),o}return e.value}catch(r){throw console.error("เกิดข้อผิดพลาดในการดึงข้อมูลโปรไฟล์ผู้ใช้:",r),u.value=r.message,r}finally{l.value=!1}},updateUserProfile:async r=>{try{if(l.value=!0,u.value=null,!e.value||!e.value.id)throw new Error("ไม่พบข้อมูลผู้ใช้");const{data:s,error:t}=await c.from("User").update(r).eq("id",e.value.id).select().single();if(t)throw new Error("ไม่สามารถอัปเดตข้อมูลผู้ใช้: "+t.message);if(!s)throw new Error("ไม่พบข้อมูลผู้ใช้หลังการอัปเดต");const i=d(s);return e.value=i,localStorage.setItem("user",JSON.stringify(i)),i}catch(s){throw console.error("เกิดข้อผิดพลาดในการอัปเดตข้อมูลผู้ใช้:",s),u.value=s.message,s}finally{l.value=!1}}}});export{P as u};
