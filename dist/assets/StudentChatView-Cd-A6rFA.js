import{s as b,g as u,f as I,m as E,x as S,y as A,c as d,a as o,i as C,t as w,F as U,n as k,h as B,j as N,v as O,p as T,o as c}from"./index-ccbdet2U.js";import{a as h}from"./supabase-1JXeVZ6_.js";const j=b("student",()=>{const _=u(null),f=u([]),i=u([]),a=u(!1),s=u(null);return{advisor:_,announcements:f,appointments:i,loading:a,error:s,fetchAdvisorById:async n=>{try{if(a.value=!0,s.value=null,!localStorage.getItem("user"))throw new Error("ไม่พบข้อมูลผู้ใช้");const{data:l,error:e}=await h.from("User").select("*").eq("id",n).single();if(e)throw e;return l}catch(t){return console.error("Error fetching advisor by ID:",t),t instanceof Error?s.value=t.message:s.value="เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ",null}finally{a.value=!1}},fetchAnnouncementsFromAdvisor:async n=>{try{if(a.value=!0,s.value=null,!localStorage.getItem("user"))throw new Error("ไม่พบข้อมูลผู้ใช้");const{data:l,error:e}=await h.from("Announcement").select("*").eq("advisorId",n).order("createdAt",{ascending:!1});if(e)throw e;return f.value=l,l}catch(t){return console.error("Error fetching announcements from advisor:",t),t instanceof Error?s.value=t.message:s.value="เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ",[]}finally{a.value=!1}},fetchStudentAppointments:async n=>{try{if(a.value=!0,s.value=null,!localStorage.getItem("user"))throw new Error("ไม่พบข้อมูลผู้ใช้");const{data:l,error:e}=await h.from("Appointment").select("*").eq("studentId",n).order("startTime",{ascending:!0});if(e)throw e;return i.value=l,l}catch(t){return console.error("Error fetching student appointments:",t),t instanceof Error?s.value=t.message:s.value="เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ",[]}finally{a.value=!1}},fetchStudentComments:async n=>{try{if(a.value=!0,s.value=null,!localStorage.getItem("user"))throw new Error("ไม่พบข้อมูลผู้ใช้");const{data:l,error:e}=await h.from("Comment").select("*").eq("studentId",n).order("createdAt",{ascending:!0});if(e)throw e;return l}catch(t){return console.error("Error fetching student comments:",t),t instanceof Error?s.value=t.message:s.value="เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ",[]}finally{a.value=!1}},addStudentComment:async n=>{try{if(a.value=!0,s.value=null,!localStorage.getItem("user"))throw new Error("ไม่พบข้อมูลผู้ใช้");const l=crypto.randomUUID();console.log("ข้อมูลที่จะส่ง:",{id:l,advisorId:n.advisorId,studentId:n.studentId,content:n.content,isAdvisorComment:n.isAdvisorComment,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});const{data:e,error:r}=await h.from("Comment").insert([{id:l,advisorId:n.advisorId,studentId:n.studentId,content:n.content,isAdvisorComment:n.isAdvisorComment,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}]).select();if(r)throw console.error("Supabase error:",r),console.error("Error code:",r.code),console.error("Error message:",r.message),console.error("Error details:",r.details),new Error(`ไม่สามารถเพิ่มข้อความได้: ${r.message}`);if(!e||e.length===0)throw console.error("ไม่มีข้อมูลที่ถูกส่งกลับมา"),new Error("ไม่สามารถเพิ่มข้อความได้: ไม่มีข้อมูลที่ถูกส่งกลับมา");return console.log("เพิ่มข้อความสำเร็จ:",e[0]),e[0]}catch(t){throw console.error("Error adding student comment:",t),t instanceof Error?s.value=t.message:s.value="เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ",t}finally{a.value=!1}}}}),D={class:"min-h-screen bg-gray-100"},q={class:"max-w-7xl mx-auto py-6 sm:px-6 lg:px-8"},F={class:"px-4 py-6 sm:px-0"},V={class:"bg-white shadow overflow-hidden sm:rounded-lg"},J={class:"px-4 py-5 sm:px-6 flex justify-between items-center"},L={key:0},M={class:"inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-green-100 text-green-800"},H={class:"border-t border-gray-200"},z={class:"px-4 py-5 sm:p-6"},$={key:0,class:"flex justify-center"},G={key:1,class:"text-center py-10"},K={key:2},P={key:0,class:"flex justify-center"},Q={key:1,class:"text-center py-10"},R={key:2},W={class:"text-xs mt-1 opacity-70"},X={class:"mt-4"},Y=["disabled"],Z=["disabled"],ee={key:0},te={key:1},oe=I({__name:"StudentChatView",setup(_){const f=j(),i=u(null),a=u([]),s=u(""),y=u(!0),p=u(!0),v=u(!1),g=u(null);E(async()=>{try{y.value=!0;const e=localStorage.getItem("user");if(!e)throw new Error("ไม่พบข้อมูลผู้ใช้");const r=JSON.parse(e);r.advisorId&&(i.value=await f.fetchAdvisorById(r.advisorId),await x())}catch(e){console.error("Error loading advisor details:",e)}finally{y.value=!1}});const x=async()=>{try{p.value=!0;const e=localStorage.getItem("user");if(!e)throw new Error("ไม่พบข้อมูลผู้ใช้");const r=JSON.parse(e),m=await f.fetchStudentComments(r.id);a.value=m||[],await S(),t()}catch(e){console.error("Error fetching comments:",e)}finally{p.value=!1}},n=async()=>{if(!s.value.trim()){alert("กรุณากรอกข้อความก่อนส่ง");return}if(!i.value||!i.value.id){console.error("ไม่พบข้อมูลอาจารย์ที่ปรึกษาหรือ ID ของอาจารย์",i.value),alert("เกิดข้อผิดพลาด: ไม่พบข้อมูลอาจารย์ที่ปรึกษา");return}try{v.value=!0;const e=localStorage.getItem("user");if(!e)throw new Error("ไม่พบข้อมูลผู้ใช้");const r=JSON.parse(e);await f.addStudentComment({studentId:r.id,advisorId:i.value.id,content:s.value,isAdvisorComment:!1}),s.value="",await x()}catch(e){console.error("Error submitting comment:",e),alert("เกิดข้อผิดพลาดในการส่งข้อความ: "+(e instanceof Error?e.message:String(e)))}finally{v.value=!1}},t=()=>{g.value&&(g.value.scrollTop=g.value.scrollHeight)},l=e=>e?new Date(e).toLocaleString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"";return A(a,()=>{S(()=>{t()})}),(e,r)=>(c(),d("div",D,[o("div",q,[o("div",F,[o("div",V,[o("div",J,[r[1]||(r[1]=o("div",null,[o("h3",{class:"text-lg leading-6 font-medium text-gray-900"},"สนทนากับอาจารย์ที่ปรึกษา"),o("p",{class:"mt-1 max-w-2xl text-sm text-gray-500"},"พูดคุยกับอาจารย์ที่ปรึกษาของคุณได้ที่นี่")],-1)),i.value?(c(),d("div",L,[o("span",M," อาจารย์ที่ปรึกษา: "+w(i.value.firstName)+" "+w(i.value.lastName),1)])):C("",!0)]),o("div",H,[o("div",z,[y.value?(c(),d("div",$,r[2]||(r[2]=[o("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"},null,-1)]))):i.value?(c(),d("div",K,[o("div",{class:"space-y-4 h-96 overflow-y-auto p-4 bg-gray-50 rounded-lg mb-4",ref_key:"chatContainer",ref:g},[p.value?(c(),d("div",P,r[4]||(r[4]=[o("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"},null,-1)]))):a.value.length===0?(c(),d("div",Q,r[5]||(r[5]=[o("p",{class:"text-gray-500"},"ยังไม่มีข้อความ",-1)]))):(c(),d("div",R,[(c(!0),d(U,null,k(a.value,m=>(c(),d("div",{key:m.id,class:T(["p-3 rounded-lg max-w-xs md:max-w-md lg:max-w-lg",m.isAdvisorComment?"bg-gray-200 text-gray-800 ml-auto":"bg-blue-500 text-white mr-auto"])},[o("p",null,w(m.content),1),o("p",W,w(l(m.createdAt)),1)],2))),128))]))],512),o("div",X,[o("form",{onSubmit:B(n,["prevent"]),class:"flex"},[N(o("textarea",{"onUpdate:modelValue":r[0]||(r[0]=m=>s.value=m),placeholder:"พิมพ์ข้อความ...",class:"shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2",disabled:v.value},null,8,Y),[[O,s.value]]),o("button",{type:"submit",class:"ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",disabled:v.value||!s.value.trim()},[v.value?(c(),d("span",ee,"กำลังส่ง...")):(c(),d("span",te,"ส่งข้อความ"))],8,Z)],32)])])):(c(),d("div",G,r[3]||(r[3]=[o("p",{class:"text-gray-500"},"คุณยังไม่มีอาจารย์ที่ปรึกษา",-1)])))])])])])])]))}});export{oe as default};
