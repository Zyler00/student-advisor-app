import{f as J,g as i,m as P,c as r,a as t,i as g,e as R,F as A,n as U,h as Z,j as m,l as V,v,t as a,p as G,o as l}from"./index-ccbdet2U.js";import{u as K}from"./advisor-D7NZ8dGp.js";import{a as T}from"./supabase-1JXeVZ6_.js";const Q={class:"pb-5 border-b border-gray-200 sm:flex sm:items-center sm:justify-between"},W={class:"mt-3 sm:mt-0 sm:ml-4"},X={class:"mt-8"},Y={key:0,class:"text-center py-4"},ee={key:1,class:"text-center py-4 bg-white shadow rounded-lg"},te={key:2,class:"space-y-4"},se={class:"px-4 py-5 sm:px-6 flex justify-between items-start"},oe={class:"text-lg leading-6 font-medium text-gray-900"},ne={class:"mt-1 max-w-2xl text-sm text-gray-500"},re={key:0,class:"mt-1 max-w-2xl text-sm text-gray-500"},ae={key:1,class:"mt-1 max-w-2xl text-sm text-gray-500"},le={class:"flex space-x-2"},de=["onClick"],ie={class:"border-t border-gray-200"},ue={class:"bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"},me={class:"mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 whitespace-pre-line"},ce={key:0,class:"bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"},fe={class:"mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"},ge={key:1,class:"bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"},ve={class:"mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"},pe={key:0,class:"fixed z-10 inset-0 overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true"},xe={class:"flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"},be={class:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"},ye={class:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"},we={class:"sm:flex sm:items-start"},he={class:"mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full"},ke={class:"mt-4 space-y-4"},Te=["value"],De={key:0,class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative",role:"alert"},Ie={class:"block sm:inline"},Se={class:"bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"},_e=["disabled"],Ae=["disabled"],Ue={key:1,class:"fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"},Ve={class:"bg-white rounded-lg shadow-xl p-6 max-w-lg w-full"},$e={class:"mb-4"},Ce={class:"mb-4"},Ee={class:"mb-4"},je={class:"flex justify-end space-x-3"},Oe=J({__name:"AppointmentsView",setup(Ne){const h=K(),y=i([]),D=i([]),p=i({}),x=i(!1),u=i(null),c=i(!1),b=i(!1),w=i(!1),n=i({id:"",studentId:"",title:"",description:"",startTime:"",endTime:"",status:"pending",location:"",note:""}),$=i(null),k=async()=>{try{x.value=!0,u.value=null;const o=localStorage.getItem("user");if(!o){u.value="กรุณาเข้าสู่ระบบก่อนดูข้อมูลการนัดหมาย",x.value=!1;return}const e=JSON.parse(o);console.log("User data from localStorage:",e);const{error:s}=await T.from("Appointment").select(`
        id,
        advisorId,
        studentId,
        title,
        description,
        startTime,
        endTime,
        status,
        location,
        note,
        createdAt,
        updatedAt
      `).eq("advisorId",e.id).order("createdAt",{ascending:!1});if(s){console.error("Error fetching appointments:",s),u.value=`ไม่สามารถดึงข้อมูลการนัดหมายได้: ${s.message}`,x.value=!1;return}console.log("Appointment data fetched:"),y.value=[],await C()}catch(o){console.error("Error loading appointments:",o),u.value=o instanceof Error?o.message:"เกิดข้อผิดพลาดในการโหลดข้อมูลการนัดหมาย"}finally{x.value=!1}},C=async()=>{try{const o=new Set;y.value.forEach(e=>{e.studentId&&o.add(e.studentId)});for(const e of o)try{const{data:s,error:f}=await T.from("User").select("id, firstName, lastName, profileImage, department").eq("id",e).single();if(f){console.error(`Error fetching student data for ID ${e}:`,f);continue}s&&(p.value[e]=s)}catch(s){console.error(`Exception when fetching student data for ID ${e}:`,s)}console.log("Updated student data:",p.value)}catch(o){console.error("Error in loadStudentData:",o)}};P(async()=>{await k(),await h.fetchStudents(),D.value=h.students});const E=async()=>{try{c.value=!0,u.value=null;const o={studentId:n.value.studentId,title:n.value.title,description:n.value.description,startTime:n.value.startTime?new Date(n.value.startTime):void 0,endTime:n.value.endTime?new Date(n.value.endTime):void 0,status:n.value.status,location:n.value.location,note:n.value.note};await h.requestAppointment(o),N(),b.value=!1,await k()}catch(o){u.value=o.message}finally{c.value=!1}},d=i({id:"",status:"",appointmentDate:"",note:""}),j=async()=>{try{c.value=!0,u.value=null;const o={id:d.value.id,status:d.value.status,startTime:d.value.appointmentDate?new Date(d.value.appointmentDate).toISOString():void 0,note:d.value.note},{error:e}=await T.from("Appointment").update({status:o.status,startTime:o.startTime,note:o.note,updatedAt:new Date().toISOString()}).eq("id",o.id);if(e)throw new Error(`ไม่สามารถอัปเดตการนัดหมายได้: ${e.message}`);w.value=!1,await k()}catch(o){u.value=o.message}finally{c.value=!1}},N=()=>{n.value={id:"",studentId:"",title:"",description:"",startTime:"",endTime:"",status:"pending",location:"",note:""},$.value=null},q=o=>{w.value=!0,d.value={id:o.id,status:o.status,appointmentDate:o.startTime?new Date(o.startTime).toISOString().replace("Z",""):"",note:o.note||""}},F=o=>{if(!o)return"ไม่ระบุ";const e=typeof o=="string"?new Date(o):o;return new Intl.DateTimeFormat("th-TH",{year:"numeric",month:"long",day:"numeric",calendar:"buddhist"}).format(e)},M=(o,e)=>{if(!o)return"ไม่ระบุ";const s=typeof o=="string"?new Date(o):o,f=new Date(s.getTime()+7*60*60*1e3),B=new Intl.DateTimeFormat("th-TH",{year:"numeric",month:"long",day:"numeric",calendar:"buddhist"}),I=new Intl.DateTimeFormat("th-TH",{hour:"2-digit",minute:"2-digit"}),S=B.format(f),_=I.format(f);if(e==="pending"){const H=new Date(f.getTime()+108e5),L=I.format(H);return`${S} เวลา ${_} - ${L} น.`}else return`${S} เวลา ${_} น.`},O=o=>{switch(o){case"pending":return"รอดำเนินการ";case"scheduled":return"อาจารย์ยืนยันกำหนดการ";case"confirmed":return"ยืนยัน";case"cancelled":return"ยกเลิกแล้ว";default:return o}},z=o=>{if(!o)return"";switch(o){case"morning":return"ช่วงเช้า (9:00 - 12:00)";case"afternoon":return"ช่วงบ่าย (13:00 - 16:00)";case"evening":return"ช่วงเย็น (16:00 - 18:00)";default:return o}};return(o,e)=>(l(),r("div",null,[t("div",Q,[e[14]||(e[14]=t("h3",{class:"text-lg leading-6 font-medium text-gray-900"},"จัดการการนัดหมาย",-1)),t("div",W,[t("button",{onClick:e[0]||(e[0]=s=>b.value=!0),class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"},e[13]||(e[13]=[t("svg",{class:"-ml-1 mr-2 h-5 w-5",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z","clip-rule":"evenodd"})],-1),R(" สร้างการนัดหมายใหม่ ")]))])]),t("div",X,[x.value?(l(),r("div",Y,e[15]||(e[15]=[t("div",{class:"text-sm text-gray-500"},"กำลังโหลดข้อมูล...",-1)]))):y.value.length===0?(l(),r("div",ee,e[16]||(e[16]=[t("div",{class:"text-sm text-gray-500"},"ยังไม่มีการนัดหมาย",-1)]))):(l(),r("div",te,[(l(!0),r(A,null,U(y.value,s=>(l(),r("div",{key:s.id,class:"bg-white shadow overflow-hidden sm:rounded-lg"},[t("div",se,[t("div",null,[t("h3",oe,a(s.title),1),t("p",ne," วันที่นัดหมาย: "+a(M(s.startTime,s.status)),1),s.preferredDate?(l(),r("p",re," วันที่นักศึกษาต้องการ: "+a(F(s.preferredDate)),1)):g("",!0),s.preferredTime?(l(),r("p",ae," ช่วงเวลาที่นักศึกษาสะดวก: "+a(z(s.preferredTime)),1)):g("",!0)]),t("div",le,[t("span",{class:G({"px-2 py-1 text-xs font-medium rounded-full":!0,"bg-yellow-100 text-yellow-800":s.status==="pending","bg-green-100 text-green-800":s.status==="confirmed","bg-red-100 text-red-800":s.status==="cancelled","bg-purple-100 text-purple-800":s.status==="scheduled"})},a(O(s.status)),3),t("button",{onClick:f=>q(s),class:"text-blue-600 hover:text-blue-900"}," อัปเดตสถานะ ",8,de)])]),t("div",ie,[t("dl",null,[t("div",ue,[e[17]||(e[17]=t("dt",{class:"text-sm font-medium text-gray-500"}," รายละเอียด ",-1)),t("dd",me,a(s.description),1)]),s.location?(l(),r("div",ce,[e[18]||(e[18]=t("dt",{class:"text-sm font-medium text-gray-500"}," สถานที่ ",-1)),t("dd",fe,a(s.location),1)])):g("",!0),p.value[s.studentId]?(l(),r("div",ge,[e[19]||(e[19]=t("dt",{class:"text-sm font-medium text-gray-500"}," นักศึกษา ",-1)),t("dd",ve,a(p.value[s.studentId].firstName)+" "+a(p.value[s.studentId].lastName)+" ("+a(p.value[s.studentId].studentId)+") ",1)])):g("",!0)])])]))),128))]))]),b.value?(l(),r("div",pe,[t("div",xe,[t("div",{class:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity","aria-hidden":"true",onClick:e[1]||(e[1]=s=>b.value=!1)}),e[28]||(e[28]=t("span",{class:"hidden sm:inline-block sm:align-middle sm:h-screen","aria-hidden":"true"},"​",-1)),t("div",be,[t("form",{onSubmit:Z(E,["prevent"])},[t("div",ye,[t("div",we,[t("div",he,[e[27]||(e[27]=t("h3",{class:"text-lg leading-6 font-medium text-gray-900",id:"modal-title"}," สร้างการนัดหมายใหม่ ",-1)),t("div",ke,[t("div",null,[e[21]||(e[21]=t("label",{for:"student",class:"block text-sm font-medium text-gray-700"},"นักศึกษา",-1)),m(t("select",{id:"student","onUpdate:modelValue":e[2]||(e[2]=s=>n.value.studentId=s),class:"mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md",required:""},[e[20]||(e[20]=t("option",{value:"",disabled:""},"เลือกนักศึกษา",-1)),(l(!0),r(A,null,U(D.value,s=>(l(),r("option",{key:s.id,value:s.id},a(s.studentId)+" - "+a(s.firstName)+" "+a(s.lastName),9,Te))),128))],512),[[V,n.value.studentId]])]),t("div",null,[e[22]||(e[22]=t("label",{for:"title",class:"block text-sm font-medium text-gray-700"},"หัวข้อการนัดหมาย",-1)),m(t("input",{type:"text",id:"title","onUpdate:modelValue":e[3]||(e[3]=s=>n.value.title=s),class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md",required:""},null,512),[[v,n.value.title]])]),t("div",null,[e[23]||(e[23]=t("label",{for:"description",class:"block text-sm font-medium text-gray-700"},"รายละเอียด",-1)),m(t("textarea",{id:"description","onUpdate:modelValue":e[4]||(e[4]=s=>n.value.description=s),rows:"3",class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md",required:""},null,512),[[v,n.value.description]])]),t("div",null,[e[24]||(e[24]=t("label",{for:"date",class:"block text-sm font-medium text-gray-700"},"วันที่นัดหมาย",-1)),m(t("input",{type:"date",id:"date","onUpdate:modelValue":e[5]||(e[5]=s=>n.value.startTime=s),class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md",required:""},null,512),[[v,n.value.startTime]])]),t("div",null,[e[25]||(e[25]=t("label",{for:"location",class:"block text-sm font-medium text-gray-700"},"สถานที่",-1)),m(t("input",{type:"text",id:"location","onUpdate:modelValue":e[6]||(e[6]=s=>n.value.location=s),class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"},null,512),[[v,n.value.location]])]),t("div",null,[e[26]||(e[26]=t("label",{for:"note",class:"block text-sm font-medium text-gray-700"},"บันทึกเพิ่มเติม",-1)),m(t("textarea",{id:"note","onUpdate:modelValue":e[7]||(e[7]=s=>n.value.note=s),rows:"2",class:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"},null,512),[[v,n.value.note]])]),u.value?(l(),r("div",De,[t("span",Ie,a(u.value),1)])):g("",!0)])])])]),t("div",Se,[t("button",{type:"submit",class:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm",disabled:c.value},a(c.value?"กำลังบันทึก...":"บันทึก"),9,_e),t("button",{type:"button",class:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm",onClick:e[8]||(e[8]=s=>b.value=!1),disabled:c.value}," ยกเลิก ",8,Ae)])],32)])])])):g("",!0),w.value?(l(),r("div",Ue,[t("div",Ve,[e[33]||(e[33]=t("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"อัปเดตการนัดหมาย",-1)),t("div",$e,[e[30]||(e[30]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"สถานะ",-1)),m(t("select",{"onUpdate:modelValue":e[9]||(e[9]=s=>d.value.status=s),class:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"},e[29]||(e[29]=[t("option",{value:"scheduled"},"อาจารย์ยืนยันกำหนดการ",-1),t("option",{value:"cancelled"},"ยกเลิกแล้ว",-1)]),512),[[V,d.value.status]])]),t("div",Ce,[e[31]||(e[31]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"วันที่นัดหมาย",-1)),m(t("input",{type:"datetime-local","onUpdate:modelValue":e[10]||(e[10]=s=>d.value.appointmentDate=s),class:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[v,d.value.appointmentDate]])]),t("div",Ee,[e[32]||(e[32]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"หมายเหตุ",-1)),m(t("textarea",{"onUpdate:modelValue":e[11]||(e[11]=s=>d.value.note=s),rows:"3",class:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"},null,512),[[v,d.value.note]])]),t("div",je,[t("button",{onClick:e[12]||(e[12]=s=>w.value=!1),class:"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"}," ยกเลิก "),t("button",{onClick:j,class:"px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"}," บันทึก ")])])])):g("",!0)]))}});export{Oe as default};
