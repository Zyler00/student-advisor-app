import{a as s,s as p}from"./supabase-1JXeVZ6_.js";import{s as $,g as w}from"./index-ccbdet2U.js";const te=$("advisor",()=>{const v=w([]),E=w([]),y=w([]),I=w([]),g=w([]),h=w([]),a=w(!1),o=w(null),A=async()=>{try{a.value=!0,o.value=null;const{data:e,error:r}=await s.from("User").select("*").eq("role","advisor").order("createdAt",{ascending:!1});if(r)throw new Error("ไม่สามารถดึงข้อมูลอาจารย์ได้: "+r.message);return v.value=e,e}catch(e){throw o.value=e.message,e}finally{a.value=!1}},U=async e=>{try{a.value=!0,o.value=null;const{data:r,error:t}=await s.from("User").select("id").eq("email",e.email).maybeSingle();if(t)throw new Error("ไม่สามารถตรวจสอบข้อมูลได้: "+t.message);if(r)throw new Error("อีเมลนี้ถูกใช้งานแล้ว กรุณาใช้อีเมลอื่น");const l={id:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(u){const d=Math.random()*16|0;return(u==="x"?d:d&3|8).toString(16)}),...e,role:"advisor",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{data:i,error:c}=await s.from("User").insert([l]).select();if(c)throw new Error("ไม่สามารถเชื่อมต่อฐานข้อมูลได้: "+c.message);return i}catch(r){throw o.value=r.message,r}finally{a.value=!1}},q=async()=>{try{a.value=!0,o.value=null;const{data:e,error:r}=await s.from("User").select("*").eq("role","student").order("createdAt",{ascending:!1});if(r)throw new Error("ไม่สามารถดึงข้อมูลนักศึกษาได้: "+r.message);return E.value=e,e}catch(e){throw o.value=e.message,e}finally{a.value=!1}},_=async e=>{try{a.value=!0,o.value=null;const{data:r,error:t}=await s.from("User").select("*").eq("role","student").or(`studentId.ilike.%${e}%,firstName.ilike.%${e}%,lastName.ilike.%${e}%`);if(t)throw new Error("ไม่สามารถค้นหานักศึกษาได้: "+t.message);return r}catch(r){throw o.value=r.message,r}finally{a.value=!1}},N=async(e,r)=>{try{a.value=!0,o.value=null;const{data:t,error:n}=await s.from("User").update({advisorId:e}).eq("id",r).select();if(n)throw new Error("ไม่สามารถกำหนดอาจารย์ที่ปรึกษาได้: "+n.message);return t}catch(t){throw o.value=t.message,t}finally{a.value=!1}},O=async()=>{try{a.value=!0;const e=localStorage.getItem("user");if(!e)throw new Error("ไม่พบข้อมูลผู้ใช้");const r=JSON.parse(e);if(r.role!=="advisor")throw new Error("ผู้ใช้ไม่ใช่อาจารย์ที่ปรึกษา");const{data:t,error:n}=await s.from("User").select("*").eq("advisorId",r.id).eq("role","student");if(n)throw n;return y.value=t,console.log("Fetched advisor students:",y.value),t}catch(e){throw console.error("Error fetching advisor students:",e),e}finally{a.value=!1}},D=async e=>{try{a.value=!0,o.value=null;const{data:{user:r}}=await p.auth.getUser();if(!r)throw new Error("ไม่พบข้อมูลผู้ใช้");const t=r.id,{data:n,error:l}=await s.from("User").select("*").eq("advisorId",t).eq("role","student").or(`studentId.ilike.%${e}%,firstName.ilike.%${e}%,lastName.ilike.%${e}%`);if(l)throw new Error("ไม่สามารถค้นหานักศึกษาได้: "+l.message);return n}catch(r){throw o.value=r.message,r}finally{a.value=!1}},C=async e=>{try{a.value=!0,o.value=null;const{data:r,error:t}=await s.from("User").select("*").eq("id",e).eq("role","advisor").single();if(t)throw new Error("ไม่สามารถดึงข้อมูลอาจารย์ได้: "+t.message);return r}catch(r){throw o.value=r.message,r}finally{a.value=!1}},S=async(e,r)=>{try{a.value=!0,o.value=null;const t=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(f){const m=Math.random()*16|0;return(f==="x"?m:m&3|8).toString(16)}),n=e.name.split(".").pop(),l=`${t()}.${n}`,i=`${r}/${l}`,c="files",{error:u}=await s.storage.from(c).upload(i,e);if(u)throw new Error("ไม่สามารถอัปโหลดไฟล์ได้: "+u.message);const{data:{publicUrl:d}}=s.storage.from(c).getPublicUrl(i);return{fileName:e.name,fileUrl:d}}catch(t){throw o.value=t.message,t}finally{a.value=!1}};return{advisors:v,students:E,advisorStudents:y,relations:I,announcements:g,appointments:h,loading:a,error:o,fetchAdvisors:A,createAdvisor:U,fetchStudents:q,searchStudents:_,assignAdvisorToStudent:N,fetchAdvisorStudents:O,searchAdvisorStudents:D,fetchAdvisorById:C,uploadFile:S,createAnnouncement:async(e,r)=>{try{a.value=!0,o.value=null;const t=localStorage.getItem("user");if(!t)throw new Error("ไม่พบข้อมูลผู้ใช้");const n=JSON.parse(t),l=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(m){const x=Math.random()*16|0;return(m==="x"?x:x&3|8).toString(16)});let i={};if(r){const m=await S(r,"announcements");i={fileName:m.fileName,fileUrl:m.fileUrl}}const u={id:l(),...e,...i,advisorId:n.id,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{data:d,error:f}=await s.from("Announcement").insert([u]).select();if(f)throw new Error("ไม่สามารถสร้างประกาศได้: "+f.message);return d&&g.value.unshift(d[0]),d}catch(t){throw o.value=t.message,t}finally{a.value=!1}},updateAnnouncement:async(e,r,t)=>{try{a.value=!0,o.value=null;let n={...r,updatedAt:new Date().toISOString()};if(t){const c=await S(t,"announcements");n={...n,fileName:c.fileName,fileUrl:c.fileUrl}}const{data:l,error:i}=await s.from("Announcement").update(n).eq("id",e).select();if(i)throw new Error("ไม่สามารถอัปเดตประกาศได้: "+i.message);if(l&&l.length>0){const c=g.value.findIndex(u=>u.id===e);c!==-1&&(g.value[c]=l[0])}return l}catch(n){throw o.value=n.message,n}finally{a.value=!1}},deleteAnnouncement:async e=>{try{a.value=!0,o.value=null;const{error:r}=await s.from("Announcement").delete().eq("id",e);if(r)throw new Error("ไม่สามารถลบประกาศได้: "+r.message);return g.value=g.value.filter(t=>t.id!==e),!0}catch(r){throw o.value=r.message,r}finally{a.value=!1}},fetchAnnouncements:async()=>{try{a.value=!0,o.value=null;const e=localStorage.getItem("user");if(!e)throw new Error("ไม่พบข้อมูลผู้ใช้");const r=JSON.parse(e),{data:t,error:n}=await s.from("Announcement").select("*").eq("advisorId",r.id).order("createdAt",{ascending:!1});if(n)throw new Error("ไม่สามารถดึงข้อมูลประกาศได้: "+n.message);return g.value=t,t}catch(e){throw o.value=e.message,e}finally{a.value=!1}},fetchStudentAnnouncements:async()=>{try{a.value=!0,o.value=null;const e=localStorage.getItem("user");if(!e)throw new Error("ไม่พบข้อมูลผู้ใช้");const r=JSON.parse(e),{data:t,error:n}=await s.from("User").select("advisorId").eq("id",r.id).single();if(n&&n.code!=="PGRST116")throw new Error("ไม่สามารถดึงข้อมูลอาจารย์ที่ปรึกษาได้: "+n.message);if(!t)return[];const{data:l,error:i}=await s.from("Announcement").select("*").eq("advisorId",t.advisorId).order("createdAt",{ascending:!1});if(i)throw new Error("ไม่สามารถดึงข้อมูลประกาศได้: "+i.message);return l}catch(e){throw o.value=e.message,e}finally{a.value=!1}},requestAppointment:async e=>{try{if(console.log("Starting appointment request with data:",e),!e.topic)throw new Error("กรุณาระบุหัวข้อการนัดหมาย");if(!e.advisorId)throw new Error("ไม่พบข้อมูลอาจารย์ที่ปรึกษา");if(!e.studentId)throw new Error("ไม่พบข้อมูลนักศึกษา");console.log("Searching for advisor with ID:",e.advisorId);const{data:r,error:t}=await s.from("User").select("*").eq("id",e.advisorId).single();if(t)throw console.error("Error searching for advisor:",t),new Error("ไม่สามารถค้นหาข้อมูลอาจารย์ที่ปรึกษาได้");if(!r)throw console.error("Advisor not found with ID:",e.advisorId),new Error("ไม่พบข้อมูลอาจารย์ที่ปรึกษา");const{data:n,error:l}=await s.from("User").select("*").eq("id",e.studentId).single();if(l)throw console.error("Error searching for student:",l),new Error("ไม่สามารถค้นหาข้อมูลนักศึกษาได้");if(!n)throw console.error("Student not found with ID:",e.studentId),new Error("ไม่พบข้อมูลนักศึกษา");const i={advisor_id:e.advisorId,student_id:e.studentId,topic:e.topic,description:e.description||null,request_date:new Date().toISOString(),preferred_date:e.preferredDate?e.preferredDate instanceof Date?e.preferredDate.toISOString():e.preferredDate:null,preferred_time:e.preferredTime,status:"pending",created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log("Creating new appointment with data:",i);try{const{data:c,error:u}=await s.from("appointment").insert([i]).select();if(u)throw console.error("Error inserting appointment:",u),new Error(`ไม่สามารถสร้างการนัดหมายได้: ${u.message}`);return console.log("Appointment created successfully:",c),c?c[0]:null}catch(c){throw console.error("Exception when creating appointment:",c),c}}catch(r){throw console.error("Error in requestAppointment:",r),r}},confirmAppointment:async(e,r,t,n)=>{try{a.value=!0,o.value=null;const l={status:"scheduled",appointment_date:r.toISOString(),location:t,note:n,updated_at:new Date().toISOString()},{data:i,error:c}=await s.from("Appointment").update(l).eq("id",e).select();if(c)throw new Error("ไม่สามารถยืนยันการนัดหมายได้: "+c.message);if(i&&i.length>0){const u=h.value.findIndex(d=>d.id===e);u!==-1&&(h.value[u]=i[0])}return i}catch(l){throw o.value=l.message,l}finally{a.value=!1}},cancelAppointment:async e=>{try{a.value=!0,o.value=null;const{data:r,error:t}=await s.from("Appointment").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("id",e).select();if(t)throw new Error("ไม่สามารถยกเลิกการนัดหมายได้: "+t.message);if(r&&r.length>0){const n=h.value.findIndex(l=>l.id===e);n!==-1&&(h.value[n]=r[0])}return r}catch(r){throw o.value=r.message,r}finally{a.value=!1}},cancelStudentAppointment:async e=>{try{a.value=!0,o.value=null;const{data:r,error:t}=await s.from("Appointment").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("id",e).select();if(t)throw new Error("ไม่สามารถยกเลิกการนัดหมายได้: "+t.message);return r}catch(r){throw o.value=r.message,r}finally{a.value=!1}},confirmStudentAppointment:async e=>{try{a.value=!0,o.value=null;const r={status:"confirmed",updated_at:new Date().toISOString()},{data:t,error:n}=await s.from("Appointment").update(r).eq("id",e).select();if(n)throw new Error("ไม่สามารถยืนยันการนัดหมายได้: "+n.message);return t}catch(r){throw o.value=r.message,r}finally{a.value=!1}},fetchAppointments:async()=>{try{a.value=!0,o.value=null;const{data:{user:e}}=await p.auth.getUser();if(!e)throw new Error("ไม่พบข้อมูลผู้ใช้");const{data:r,error:t}=await s.from("Appointment").select(`
          *,
          student:student_id(id, firstName, lastName, studentId, profileImage, department)
        `).eq("advisor_id",e.id).order("created_at",{ascending:!1});if(t)throw new Error("ไม่สามารถดึงข้อมูลการนัดหมายได้: "+t.message);return h.value=r,r}catch(e){throw o.value=e.message,e}finally{a.value=!1}},fetchStudentAppointments:async()=>{try{a.value=!0,o.value=null;const{data:{user:e}}=await p.auth.getUser();if(!e)throw new Error("ไม่พบข้อมูลผู้ใช้");const{data:r,error:t}=await s.from("Appointment").select(`
          *,
          advisor:advisor_id(id, firstName, lastName, profileImage, department)
        `).eq("student_id",e.id).order("created_at",{ascending:!1});if(t)throw new Error("ไม่สามารถดึงข้อมูลการนัดหมายได้: "+t.message);return r}catch(e){throw o.value=e.message,e}finally{a.value=!1}},fetchAllAppointments:async()=>{try{a.value=!0,o.value=null;const{data:e,error:r}=await s.from("Appointment").select("*").order("createdAt",{ascending:!1});if(r)throw new Error("ไม่สามารถดึงข้อมูลการนัดหมายได้: "+r.message);console.log("ดึงข้อมูลการนัดหมายสำเร็จ:",e);const t=e.map(n=>({...n,title:n.title||n.topic||"ไม่มีหัวข้อ",startTime:n.startTime||n.appointmentDate||n.requestDate||new Date,endTime:n.endTime||new Date(new Date(n.appointmentDate||n.requestDate||new Date).getTime()+60*60*1e3)}));return console.log("ข้อมูลการนัดหมายหลังแปลง:",t),h.value=t,t}catch(e){throw console.error("เกิดข้อผิดพลาดในการดึงข้อมูลการนัดหมาย:",e),o.value=e.message,e}finally{a.value=!1}},fetchAllRelations:async()=>{try{a.value=!0,o.value=null;const{data:e,error:r}=await s.from("User").select("id, firstName, lastName, studentId, department, profileImage, advisorId").not("advisorId","is",null).eq("role","student").order("created_at",{ascending:!1});if(r)throw new Error("ไม่สามารถดึงข้อมูลความสัมพันธ์ได้: "+r.message);return e.map(n=>({id:n.id,advisorId:n.advisorId,studentId:n.id,createdAt:n.createdAt}))}catch(e){throw o.value=e.message,e}finally{a.value=!1}},updateAdvisorProfile:async e=>{try{if(a.value=!0,o.value=null,!e.id)throw new Error("ไม่พบ ID ของอาจารย์");if(e.email){const{data:l,error:i}=await s.from("User").select("id").eq("email",e.email).neq("id",e.id).maybeSingle();if(i)throw new Error("ไม่สามารถตรวจสอบข้อมูลได้: "+i.message);if(l)throw new Error("อีเมลนี้ถูกใช้งานแล้ว กรุณาใช้อีเมลอื่น")}const{data:r,error:t}=await s.from("User").update(e).eq("id",e.id).eq("role","advisor").select();if(t)throw new Error("ไม่สามารถอัปเดตข้อมูลอาจารย์ได้: "+t.message);const n=v.value.findIndex(l=>l.id===e.id);return n!==-1&&r&&r.length>0&&(v.value[n]={...v.value[n],...r[0]}),r&&r.length>0?r[0]:null}catch(r){throw o.value=r.message,r}finally{a.value=!1}},deleteAdvisor:async e=>{try{a.value=!0,o.value=null;const{error:r}=await s.from("User").delete().eq("id",e).eq("role","advisor");if(r)throw new Error("ไม่สามารถลบข้อมูลอาจารย์ได้: "+r.message);return v.value=v.value.filter(t=>t.id!==e),!0}catch(r){throw o.value=r.message,r}finally{a.value=!1}},fetchStudentById:async e=>{try{a.value=!0;const{data:r,error:t}=await s.from("User").select("*").eq("id",e).eq("role","student").single();if(t)throw t;return r}catch(r){throw console.error("Error fetching student by ID:",r),r}finally{a.value=!1}},fetchStudentComments:async e=>{try{if(a.value=!0,!localStorage.getItem("user"))throw new Error("ไม่พบข้อมูลผู้ใช้");const{data:t,error:n}=await s.from("Comment").select("*").eq("student_id",e).order("created_at",{ascending:!0});if(n)throw n;return t}catch(r){throw console.error("Error fetching student comments:",r),r}finally{a.value=!1}},addStudentComment:async e=>{try{a.value=!0;const r=localStorage.getItem("user");if(!r)throw new Error("ไม่พบข้อมูลผู้ใช้");const n=JSON.parse(r).id,i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(m){const x=Math.random()*16|0;return(m==="x"?x:x&3|8).toString(16)});console.log("ข้อมูลที่จะส่ง:",{id:i,advisor_id:n,student_id:e.studentId,content:e.content,is_advisor_comment:e.isAdvisorComment,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),console.log("ทดสอบการเข้าถึงตาราง Comment...");const{data:c,error:u}=await s.from("Comment").select("count");if(u)throw console.error("ไม่สามารถเข้าถึงตาราง Comment:",u),new Error(`ไม่สามารถเข้าถึงตาราง Comment: ${u.message}`);console.log("สามารถเข้าถึงตาราง Comment ได้:",c);const{data:d,error:f}=await s.from("Comment").insert([{id:i,advisor_id:n,student_id:e.studentId,content:e.content,is_advisor_comment:e.isAdvisorComment,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select();if(f)throw console.error("Supabase error:",f),console.error("Error code:",f.code),console.error("Error message:",f.message),console.error("Error details:",f.details),new Error(`ไม่สามารถเพิ่มข้อความได้: ${f.message}`);if(!d||d.length===0)throw console.error("ไม่มีข้อมูลที่ถูกส่งกลับมา"),new Error("ไม่สามารถเพิ่มข้อความได้: ไม่มีข้อมูลที่ถูกส่งกลับมา");return console.log("เพิ่มข้อความสำเร็จ:",d[0]),d[0]}catch(r){throw console.error("Error adding student comment:",r),r instanceof Error?o.value=r.message:o.value="เกิดข้อผิดพลาดที่ไม่ทราบสาเหตุ",r}finally{a.value=!1}},checkSession:async()=>{try{console.log("Checking session status");const{data:e,error:r}=await p.auth.getSession();if(r)return console.error("Error checking session:",r),{data:{session:null,user:null},error:r};if(!e.session){console.log("No active session found in Supabase, but using localStorage data");const t=localStorage.getItem("user");if(t){const n=JSON.parse(t);return console.log("Using user data from localStorage:",n.username),{data:{session:{user:{id:n.id}},user:n},error:null}}}return{data:e,error:r}}catch(e){return console.error("Exception in checkSession:",e),{data:{session:null,user:null},error:e instanceof Error?e:new Error(String(e))}}}}});export{te as u};
